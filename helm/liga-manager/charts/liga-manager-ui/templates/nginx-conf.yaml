apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "liga-manager-ui.fullname" . }}-nginx
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "liga-manager-ui.labels" . | nindent 4 }}
data:
  default.conf: |
    upstream imgproxy {
      {{ if .Values.env.IMG_PROXY_HOST }}
      server {{ .Values.env.IMG_PROXY_HOST }}:{{ .Values.env.IMG_PROXY_PORT | default 8080 }};
      {{ else }}
      server {{ .Release.Name }}-imgproxy:{{ .Values.env.IMG_PROXY_PORT | default 8080 }};
      {{ end }}
    }
    upstream api {
      {{ if .Values.env.API_HOST }}
      server {{ .Values.env.API_HOST }}:{{ .Values.env.API_PORT | default 9000 }};
      {{ else }}
      server {{ .Release.Name }}-liga-manager-api:{{ .Values.env.API_PORT | default 9000 }};
      {{ end }}
    }
    server {
        listen {{ .Values.service.port }};
        http2 on;
        server_name localhost;
        server_tokens off;
        gzip on;
        gzip_types application/json application/javascript image/webp image/png application/font-woff2 image/x-icon;

        include /nginx-ui-conf/nginx.ui.conf;

        location /api {
          # Answer preflight request directly (required for Android app)
          if ($request_method = 'OPTIONS') {
              add_header 'Access-Control-Allow-Origin' 'https://localhost';
              add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
              add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
              add_header 'Access-Control-Expose-Headers' 'Content-Encoding,X-Token';
              add_header 'Access-Control-Max-Age' 60;
              add_header 'Content-Type' 'text/plain; charset=UTF-8';
              add_header 'Content-Length' 0;
              return 204; # No Content response
          }

          # Add the CORS headers to application responses as well (required for Android app)
          add_header 'Access-Control-Allow-Origin' 'https://localhost' always;
          add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
          add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
          add_header 'Access-Control-Expose-Headers' 'Content-Encoding,X-Token';

          include fastcgi_params;
          fastcgi_pass api;
          fastcgi_param DOCUMENT_ROOT /var/www/api/public;
          fastcgi_param SCRIPT_NAME index.php;
          fastcgi_param SCRIPT_FILENAME /var/www/api/public/index.php;
        }
    }