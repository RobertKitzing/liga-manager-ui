name: Pull Requests

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

on:
  pull_request:
      types: 
          - opened

jobs:
    npm-install:
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: package-lock.json
      - uses: actions/cache/restore@v4
        id: cache_restore
        with:
          path: ./node_modules
          key: modules-${{ hashFiles('package-lock.json') }}
      - run: npm ci
      - name: Cache dependencies
        id: cache
        uses: actions/cache@v4
        with:
          path: ./node_modules
          key: modules-${{ hashFiles('package-lock.json') }}
    lint:
      runs-on: ubuntu-latest
      needs: 
        - npm-install
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - uses: actions/cache/restore@v4
          id: cache
          with:
            path: ./node_modules
            key: modules-${{ hashFiles('package-lock.json') }}
        - uses: nrwl/nx-set-shas@v4
          with:
            main-branch-name: next_nx
        - run: |
            echo "BASE: ${{ env.NX_BASE }}"
            echo "HEAD: ${{ env.NX_HEAD }}"
        - run: npx nx-cloud record -- nx affected -t lint
    build:
      runs-on: ubuntu-latest
      needs: 
        - test
      steps:
        - uses: actions/checkout@v4

        - uses: actions/cache/restore@v4
          id: cache
          with:
            path: ./node_modules
            key: modules-${{ hashFiles('package-lock.json') }}
        - uses: nrwl/nx-set-shas@v4
          with:
            main-branch-name: next_nx
        - run: |
            echo "BASE: ${{ env.NX_BASE }}"
            echo "HEAD: ${{ env.NX_HEAD }}"
        - run: npx nx-cloud record -- nx run liga-manager-ui-web:build:production
    test:
      runs-on: ubuntu-latest
      needs: 
        - npm-install
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0
        - uses: actions/cache/restore@v4
          id: cache
          with:
            path: ./node_modules
            key: modules-${{ hashFiles('package-lock.json') }}
        - uses: nrwl/nx-set-shas@v4
          with:
            main-branch-name: next_nx
        - run: |
            echo "BASE: ${{ env.NX_BASE }}"
            echo "HEAD: ${{ env.NX_HEAD }}"
        - run: npx nx-cloud record -- nx affected -t test